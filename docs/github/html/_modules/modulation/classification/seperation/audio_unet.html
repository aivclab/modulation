<!DOCTYPE html>

<html lang='en'>
  <head>
    <meta charset='utf-8'/>
    <meta content='width=device-width, initial-scale=1.0' name='viewport'/>
    <title>modulation.classification.seperation.audio_unet &#8212; modulation 0.0.1 documentation</title>
    <link href='../../../../_static/pygments.css' rel='stylesheet' type='text/css'/>
    <link href='../../../../_static/alabaster.css' rel='stylesheet' type='text/css'/>
    <link href='../../../../_static/graphviz.css' rel='stylesheet' type='text/css'/>
    <script data-url_root='../../../../' id='documentation_options' src='../../../../_static/documentation_options.js'></script>
    <script src='../../../../_static/jquery.js'></script>
    <script src='../../../../_static/underscore.js'></script>
    <script src='../../../../_static/_sphinx_javascript_frameworks_compat.js'></script>
    <script src='../../../../_static/doctools.js'></script>
    <link href='Aivclab.github.io/modulation/_modules/modulation/classification/seperation/audio_unet.html' rel='canonical'/>
    <link href='../../../../genindex.html' rel='index' title='Index'/>
    <link href='../../../../search.html' rel='search' title='Search'/>

    <link href='../../../../_static/custom.css' rel='stylesheet' type='text/css'/>


    <meta content='width=device-width, initial-scale=0.9, maximum-scale=0.9' name='viewport'/>

  </head>
  <body>


    <div class='document'>
      <div class='documentwrapper'>
        <div class='bodywrapper'>


          <div class='body' role='main'>

            <h1>Source code for modulation.classification.seperation.audio_unet</h1>
            <div class='highlight'><pre>
<span></span><span class='ch'>#!/usr/bin/env python3</span>
<span class='c1'># -*- coding: utf-8 -*-</span>

<span class='n'>__author__</span> <span class='o'>=</span> <span class='s2'>&quot;Christian&quot;</span>
<span class='vm'>__doc__</span> <span class='o'>=</span> <span class='sa'>r</span><span class='s2'>&quot;&quot;&quot;</span>

<span class='s2'>           Created on 29/03/2020</span>
<span class='s2'>           &quot;&quot;&quot;</span>

<span class='kn'>from</span> <span class='nn'>typing</span> <span class='kn'>import</span> <span class='n'>List</span><span class='p'>,</span> <span class='n'>Tuple</span>

<span class='kn'>import</span> <span class='nn'>torch</span>
<span class='kn'>from</span> <span class='nn'>draugr.writers</span> <span class='kn'>import</span> <span class='n'>Writer</span>
<span class='kn'>from</span> <span class='nn'>torch</span> <span class='kn'>import</span> <span class='n'>nn</span>

<span class='kn'>from</span> <span class='nn'>modulation.torch_utilities</span> <span class='kn'>import</span> <span class='n'>torch_transforms</span>

<span class='n'>__all__</span> <span class='o'>=</span> <span class='p'>[</span><span class='s1'>&#39;UNetConvBlock&#39;</span><span class='p'>,</span><span class='s1'>&#39;UNetDeconvBlock&#39;</span><span class='p'>,</span><span class='s1'>&#39;UNet&#39;</span><span class='p'>]</span>

<div class='viewcode-block' id='UNetConvBlock'><a class='viewcode-back' href='../../../../generated/modulation.classification.seperation.audio_unet.UNetConvBlock.html#modulation.classification.seperation.audio_unet.UNetConvBlock'>[docs]</a><span class='k'>class</span> <span class='nc'>UNetConvBlock</span><span class='p'>(</span><span class='n'>nn</span><span class='o'>.</span><span class='n'>Module</span><span class='p'>):</span>
    <span class='sd'>&quot;&quot;&quot;description&quot;&quot;&quot;</span>

<div class='viewcode-block' id='UNetConvBlock.__init__'><a class='viewcode-back' href='../../../../generated/modulation.classification.seperation.audio_unet.UNetConvBlock.html#modulation.classification.seperation.audio_unet.UNetConvBlock.__init__'>[docs]</a>    <span class='k'>def</span> <span class='fm'>__init__</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span> <span class='n'>in_channels</span><span class='p'>:</span> <span class='nb'>int</span><span class='p'>,</span> <span class='n'>out_channels</span><span class='p'>:</span> <span class='nb'>int</span><span class='p'>,</span> <span class='n'>kernel_size</span><span class='p'>:</span> <span class='nb'>int</span><span class='p'>):</span>
        <span class='nb'>super</span><span class='p'>()</span><span class='o'>.</span><span class='fm'>__init__</span><span class='p'>()</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>conv</span> <span class='o'>=</span> <span class='n'>nn</span><span class='o'>.</span><span class='n'>Sequential</span><span class='p'>(</span>
            <span class='n'>nn</span><span class='o'>.</span><span class='n'>Conv2d</span><span class='p'>(</span>
                <span class='n'>in_channels</span><span class='p'>,</span>
                <span class='n'>out_channels</span><span class='p'>,</span>
                <span class='n'>kernel_size</span><span class='p'>,</span>
                <span class='n'>stride</span><span class='o'>=</span><span class='mi'>2</span><span class='p'>,</span>
                <span class='n'>padding</span><span class='o'>=</span><span class='n'>kernel_size</span> <span class='o'>//</span> <span class='mi'>2</span><span class='p'>,</span>
            <span class='p'>),</span>
            <span class='n'>nn</span><span class='o'>.</span><span class='n'>BatchNorm2d</span><span class='p'>(</span><span class='n'>out_channels</span><span class='p'>),</span>
            <span class='n'>nn</span><span class='o'>.</span><span class='n'>LeakyReLU</span><span class='p'>(</span><span class='mf'>0.2</span><span class='p'>),</span>
        <span class='p'>)</span></div>

<div class='viewcode-block' id='UNetConvBlock.forward'><a class='viewcode-back' href='../../../../generated/modulation.classification.seperation.audio_unet.UNetConvBlock.html#modulation.classification.seperation.audio_unet.UNetConvBlock.forward'>[docs]</a>    <span class='k'>def</span> <span class='nf'>forward</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span> <span class='n'>x</span><span class='p'>):</span>
        <span class='sd'>&quot;&quot;&quot;</span>

<span class='sd'>        :param x:</span>
<span class='sd'>        :type x:</span>
<span class='sd'>        :return:</span>
<span class='sd'>        :rtype:</span>
<span class='sd'>        &quot;&quot;&quot;</span>
        <span class='k'>return</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>conv</span><span class='p'>(</span><span class='n'>x</span><span class='p'>)</span></div></div>


<div class='viewcode-block' id='UNetDeconvBlock'><a class='viewcode-back' href='../../../../generated/modulation.classification.seperation.audio_unet.UNetDeconvBlock.html#modulation.classification.seperation.audio_unet.UNetDeconvBlock'>[docs]</a><span class='k'>class</span> <span class='nc'>UNetDeconvBlock</span><span class='p'>(</span><span class='n'>nn</span><span class='o'>.</span><span class='n'>Module</span><span class='p'>):</span>
    <span class='sd'>&quot;&quot;&quot;description&quot;&quot;&quot;</span>

<div class='viewcode-block' id='UNetDeconvBlock.__init__'><a class='viewcode-back' href='../../../../generated/modulation.classification.seperation.audio_unet.UNetDeconvBlock.html#modulation.classification.seperation.audio_unet.UNetDeconvBlock.__init__'>[docs]</a>    <span class='k'>def</span> <span class='fm'>__init__</span><span class='p'>(</span>
        <span class='bp'>self</span><span class='p'>,</span>
        <span class='n'>in_channels</span><span class='p'>:</span> <span class='nb'>int</span><span class='p'>,</span>
        <span class='n'>out_channels</span><span class='p'>:</span> <span class='nb'>int</span><span class='p'>,</span>
        <span class='n'>kernel_size</span><span class='p'>:</span> <span class='nb'>int</span><span class='p'>,</span>
        <span class='n'>dropout</span><span class='o'>=</span><span class='mi'>0</span><span class='p'>,</span>
        <span class='n'>activation</span><span class='o'>=</span><span class='s2'>&quot;relu&quot;</span><span class='p'>,</span>
    <span class='p'>):</span>
        <span class='nb'>super</span><span class='p'>()</span><span class='o'>.</span><span class='fm'>__init__</span><span class='p'>()</span>
        <span class='k'>if</span> <span class='n'>activation</span> <span class='o'>==</span> <span class='s2'>&quot;relu&quot;</span><span class='p'>:</span>
            <span class='n'>activation_layer</span> <span class='o'>=</span> <span class='n'>nn</span><span class='o'>.</span><span class='n'>ReLU</span><span class='p'>()</span>
        <span class='k'>elif</span> <span class='n'>activation</span> <span class='o'>==</span> <span class='s2'>&quot;sigmoid&quot;</span><span class='p'>:</span>
            <span class='n'>activation_layer</span> <span class='o'>=</span> <span class='n'>nn</span><span class='o'>.</span><span class='n'>Sigmoid</span><span class='p'>()</span>
        <span class='k'>else</span><span class='p'>:</span>
            <span class='k'>raise</span> <span class='ne'>ValueError</span><span class='p'>(</span><span class='sa'>f</span><span class='s2'>&quot;Invalid activation in UNetDeconvBlock: </span><span class='si'>{</span><span class='n'>activation</span><span class='si'>}</span><span class='s2'>&quot;</span><span class='p'>)</span>
        <span class='k'>if</span> <span class='n'>dropout</span><span class='p'>:</span>
            <span class='n'>dropout_layer</span> <span class='o'>=</span> <span class='n'>nn</span><span class='o'>.</span><span class='n'>Dropout2d</span><span class='p'>()</span>
        <span class='k'>else</span><span class='p'>:</span>
            <span class='n'>dropout_layer</span> <span class='o'>=</span> <span class='n'>nn</span><span class='o'>.</span><span class='n'>Identity</span><span class='p'>()</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>conv</span> <span class='o'>=</span> <span class='n'>nn</span><span class='o'>.</span><span class='n'>Sequential</span><span class='p'>(</span>
            <span class='n'>nn</span><span class='o'>.</span><span class='n'>ConvTranspose2d</span><span class='p'>(</span>
                <span class='n'>in_channels</span><span class='p'>,</span>
                <span class='n'>out_channels</span><span class='p'>,</span>
                <span class='n'>kernel_size</span><span class='p'>,</span>
                <span class='n'>stride</span><span class='o'>=</span><span class='mi'>2</span><span class='p'>,</span>
                <span class='n'>padding</span><span class='o'>=</span><span class='n'>kernel_size</span> <span class='o'>//</span> <span class='mi'>2</span><span class='p'>,</span>
                <span class='n'>output_padding</span><span class='o'>=</span><span class='mi'>1</span><span class='p'>,</span>
            <span class='p'>),</span>
            <span class='n'>nn</span><span class='o'>.</span><span class='n'>BatchNorm2d</span><span class='p'>(</span><span class='n'>out_channels</span><span class='p'>),</span>
            <span class='n'>dropout_layer</span><span class='p'>,</span>
            <span class='n'>activation_layer</span><span class='p'>,</span>
        <span class='p'>)</span></div>

<div class='viewcode-block' id='UNetDeconvBlock.forward'><a class='viewcode-back' href='../../../../generated/modulation.classification.seperation.audio_unet.UNetDeconvBlock.html#modulation.classification.seperation.audio_unet.UNetDeconvBlock.forward'>[docs]</a>    <span class='k'>def</span> <span class='nf'>forward</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span> <span class='n'>x</span><span class='p'>,</span> <span class='n'>residual</span><span class='o'>=</span><span class='kc'>None</span><span class='p'>):</span>
        <span class='sd'>&quot;&quot;&quot;</span>
<span class='sd'>        Concatenate x with residual and deconvolve</span>
<span class='sd'>        :param x: torch.tensor of shape (1, n_fft, seq_len)</span>
<span class='sd'>        :param residual: torch.tensor of shape (1, n_fft, seq_len) or None</span>
<span class='sd'>        :return:</span>
<span class='sd'>        &quot;&quot;&quot;</span>
        <span class='k'>if</span> <span class='n'>residual</span> <span class='ow'>is</span> <span class='ow'>not</span> <span class='kc'>None</span><span class='p'>:</span>
            <span class='n'>x</span> <span class='o'>=</span> <span class='n'>torch</span><span class='o'>.</span><span class='n'>cat</span><span class='p'>([</span><span class='n'>x</span><span class='p'>,</span> <span class='n'>residual</span><span class='p'>],</span> <span class='n'>dim</span><span class='o'>=</span><span class='mi'>1</span><span class='p'>)</span>
        <span class='k'>return</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>conv</span><span class='p'>(</span><span class='n'>x</span><span class='p'>)</span></div></div>


<div class='viewcode-block' id='UNet'><a class='viewcode-back' href='../../../../generated/modulation.classification.seperation.audio_unet.UNet.html#modulation.classification.seperation.audio_unet.UNet'>[docs]</a><span class='k'>class</span> <span class='nc'>UNet</span><span class='p'>(</span><span class='n'>nn</span><span class='o'>.</span><span class='n'>Module</span><span class='p'>):</span>
    <span class='sd'>&quot;&quot;&quot;</span>
<span class='sd'>    UNet for source separation from https://ejhumphrey.com/assets/pdf/jansson2017singing.pdf</span>
<span class='sd'>    :param conv_channels_list: List of number of channels in convolutional blocks</span>
<span class='sd'>    :param spec_transform: Spectrogram transform with proper parameters from core.transforms</span>
<span class='sd'>    :param inv_spec_transform: InverseSpectrogram transform with proper parameters from core.transforms</span>
<span class='sd'>    :param optimizer_lr: Learning rate for Adam optimizer</span>
<span class='sd'>    &quot;&quot;&quot;</span>

<div class='viewcode-block' id='UNet.__init__'><a class='viewcode-back' href='../../../../generated/modulation.classification.seperation.audio_unet.UNet.html#modulation.classification.seperation.audio_unet.UNet.__init__'>[docs]</a>    <span class='k'>def</span> <span class='fm'>__init__</span><span class='p'>(</span>
        <span class='bp'>self</span><span class='p'>,</span>
        <span class='n'>conv_channels_list</span><span class='p'>:</span> <span class='n'>List</span><span class='p'>[</span><span class='nb'>int</span><span class='p'>]</span> <span class='o'>=</span> <span class='p'>(</span><span class='mi'>64</span><span class='p'>,</span> <span class='mi'>128</span><span class='p'>,</span> <span class='mi'>256</span><span class='p'>,</span> <span class='mi'>512</span><span class='p'>,</span> <span class='mi'>1024</span><span class='p'>),</span>
        <span class='n'>kernel_size</span><span class='p'>:</span> <span class='nb'>int</span> <span class='o'>=</span> <span class='mi'>3</span><span class='p'>,</span>
        <span class='n'>spec_transform</span><span class='p'>:</span> <span class='n'>torch_transforms</span><span class='o'>.</span><span class='n'>Spectrogram</span> <span class='o'>=</span> <span class='n'>torch_transforms</span><span class='o'>.</span><span class='n'>Spectrogram</span><span class='p'>,</span>
        <span class='n'>inv_spec_transform</span><span class='p'>:</span> <span class='n'>torch_transforms</span><span class='o'>.</span><span class='n'>InverseSpectrogram</span> <span class='o'>=</span> <span class='n'>torch_transforms</span><span class='o'>.</span><span class='n'>InverseSpectrogram</span><span class='p'>,</span>
        <span class='n'>optimizer_lr</span><span class='p'>:</span> <span class='nb'>float</span> <span class='o'>=</span> <span class='mf'>0.001</span><span class='p'>,</span>
    <span class='p'>)</span> <span class='o'>-&gt;</span> <span class='kc'>None</span><span class='p'>:</span>
        <span class='nb'>super</span><span class='p'>()</span><span class='o'>.</span><span class='fm'>__init__</span><span class='p'>()</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>spec_transform</span> <span class='o'>=</span> <span class='n'>spec_transform</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>inv_spec_transform</span> <span class='o'>=</span> <span class='n'>inv_spec_transform</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>optimizer_lr</span> <span class='o'>=</span> <span class='n'>optimizer_lr</span>

        <span class='n'>conv_blocks</span> <span class='o'>=</span> <span class='p'>[]</span>
        <span class='k'>for</span> <span class='n'>in_c</span><span class='p'>,</span> <span class='n'>out_c</span> <span class='ow'>in</span> <span class='nb'>zip</span><span class='p'>([</span><span class='mi'>1</span><span class='p'>]</span> <span class='o'>+</span> <span class='n'>conv_channels_list</span><span class='p'>[:</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>],</span> <span class='n'>conv_channels_list</span><span class='p'>):</span>
            <span class='n'>conv_blocks</span><span class='o'>.</span><span class='n'>append</span><span class='p'>(</span><span class='n'>UNetConvBlock</span><span class='p'>(</span><span class='n'>in_c</span><span class='p'>,</span> <span class='n'>out_c</span><span class='p'>,</span> <span class='n'>kernel_size</span><span class='p'>))</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>conv_blocks</span> <span class='o'>=</span> <span class='n'>nn</span><span class='o'>.</span><span class='n'>ModuleList</span><span class='p'>(</span><span class='n'>conv_blocks</span><span class='p'>)</span>

        <span class='c1'># First block does not have residual</span>
        <span class='n'>deconv_blocks</span> <span class='o'>=</span> <span class='p'>[]</span>
        <span class='k'>for</span> <span class='n'>i</span><span class='p'>,</span> <span class='p'>(</span><span class='n'>in_c</span><span class='p'>,</span> <span class='n'>out_c</span><span class='p'>)</span> <span class='ow'>in</span> <span class='nb'>enumerate</span><span class='p'>(</span>
            <span class='nb'>zip</span><span class='p'>(</span><span class='n'>conv_channels_list</span><span class='p'>[::</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>],</span> <span class='n'>conv_channels_list</span><span class='p'>[::</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>][</span><span class='mi'>1</span><span class='p'>:]</span> <span class='o'>+</span> <span class='p'>[</span><span class='mi'>1</span><span class='p'>])</span>
        <span class='p'>):</span>
            <span class='n'>in_c</span> <span class='o'>=</span> <span class='n'>in_c</span> <span class='o'>*</span> <span class='mi'>2</span> <span class='k'>if</span> <span class='n'>i</span> <span class='o'>&gt;</span> <span class='mi'>0</span> <span class='k'>else</span> <span class='n'>in_c</span>
            <span class='n'>dropout</span> <span class='o'>=</span> <span class='mf'>0.5</span> <span class='k'>if</span> <span class='n'>i</span> <span class='o'>&lt;</span> <span class='mi'>3</span> <span class='k'>else</span> <span class='mi'>0</span>
            <span class='n'>activation</span> <span class='o'>=</span> <span class='s2'>&quot;relu&quot;</span> <span class='k'>if</span> <span class='n'>i</span> <span class='o'>&lt;</span> <span class='nb'>len</span><span class='p'>(</span><span class='n'>conv_channels_list</span><span class='p'>)</span> <span class='o'>-</span> <span class='mi'>1</span> <span class='k'>else</span> <span class='s2'>&quot;sigmoid&quot;</span>
            <span class='n'>deconv_blocks</span><span class='o'>.</span><span class='n'>append</span><span class='p'>(</span>
                <span class='n'>UNetDeconvBlock</span><span class='p'>(</span>
                    <span class='n'>in_c</span><span class='p'>,</span> <span class='n'>out_c</span><span class='p'>,</span> <span class='n'>kernel_size</span><span class='p'>,</span> <span class='n'>dropout</span><span class='o'>=</span><span class='n'>dropout</span><span class='p'>,</span> <span class='n'>activation</span><span class='o'>=</span><span class='n'>activation</span>
                <span class='p'>)</span>
            <span class='p'>)</span>
        <span class='bp'>self</span><span class='o'>.</span><span class='n'>deconv_blocks</span> <span class='o'>=</span> <span class='n'>nn</span><span class='o'>.</span><span class='n'>ModuleList</span><span class='p'>(</span><span class='n'>deconv_blocks</span><span class='p'>)</span></div>

<div class='viewcode-block' id='UNet.forward'><a class='viewcode-back' href='../../../../generated/modulation.classification.seperation.audio_unet.UNet.html#modulation.classification.seperation.audio_unet.UNet.forward'>[docs]</a>    <span class='k'>def</span> <span class='nf'>forward</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span> <span class='n'>x</span><span class='p'>:</span> <span class='n'>torch</span><span class='o'>.</span><span class='n'>Tensor</span><span class='p'>)</span> <span class='o'>-&gt;</span> <span class='n'>torch</span><span class='o'>.</span><span class='n'>Tensor</span><span class='p'>:</span>
        <span class='sd'>&quot;&quot;&quot;</span>
<span class='sd'>        Calculates forward pass.</span>
<span class='sd'>        :param x: tensor of shape (bs, n_fft, spec_len) -- input spectrogram</span>
<span class='sd'>        :return: tensor of shape (bs, n_fft, seq_len) -- output mask</span>
<span class='sd'>        &quot;&quot;&quot;</span>
        <span class='c1'># x = (x - x.min()) / x.max()</span>
        <span class='n'>x</span> <span class='o'>=</span> <span class='n'>x</span><span class='o'>.</span><span class='n'>unsqueeze</span><span class='p'>(</span><span class='mi'>1</span><span class='p'>)</span>
        <span class='n'>residuals</span> <span class='o'>=</span> <span class='p'>[]</span>
        <span class='k'>for</span> <span class='n'>block</span> <span class='ow'>in</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>conv_blocks</span><span class='p'>:</span>
            <span class='n'>x</span> <span class='o'>=</span> <span class='n'>block</span><span class='p'>(</span><span class='n'>x</span><span class='p'>)</span>
            <span class='n'>residuals</span><span class='o'>.</span><span class='n'>append</span><span class='p'>(</span><span class='n'>x</span><span class='p'>)</span>
        <span class='n'>residuals</span><span class='p'>[</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>]</span> <span class='o'>=</span> <span class='kc'>None</span>  <span class='c1'># For first deconv block</span>
        <span class='n'>residuals</span> <span class='o'>=</span> <span class='nb'>list</span><span class='p'>(</span><span class='nb'>reversed</span><span class='p'>(</span><span class='n'>residuals</span><span class='p'>))</span>

        <span class='k'>for</span> <span class='n'>block</span><span class='p'>,</span> <span class='n'>residual</span> <span class='ow'>in</span> <span class='nb'>zip</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>deconv_blocks</span><span class='p'>,</span> <span class='n'>residuals</span><span class='p'>):</span>
            <span class='n'>x</span> <span class='o'>=</span> <span class='n'>block</span><span class='p'>(</span><span class='n'>x</span><span class='p'>,</span> <span class='n'>residual</span><span class='p'>)</span>

        <span class='n'>x</span> <span class='o'>=</span> <span class='n'>x</span><span class='o'>.</span><span class='n'>squeeze</span><span class='p'>(</span><span class='mi'>1</span><span class='p'>)</span>
        <span class='k'>return</span> <span class='n'>x</span></div>

    <span class='c1'># def inference(self, spectrogram):</span>
    <span class='c1'>#     &quot;&quot;&quot;</span>
    <span class='c1'>#     Calculates waveform from spectrogram</span>
    <span class='c1'>#     :param spectrogram:</span>
    <span class='c1'>#     :return: tensor of shape (bs, 1, seq_len) -- predicted waveform</span>
    <span class='c1'>#     &quot;&quot;&quot;</span>
    <span class='c1'>#     spectrogram = self.melspec_upsampler(spectrogram)</span>
    <span class='c1'>#     bs, _, seq_len = spectrogram.shape</span>
    <span class='c1'>#</span>
    <span class='c1'>#     cur_waveform = torch.zeros([bs, 1, 1], device=self.device)</span>
    <span class='c1'>#     while cur_waveform.shape[2] &lt; spectrogram.shape[2]:</span>
    <span class='c1'>#         print(f&quot;{cur_waveform.shape[2]}/{spectrogram.shape[2]}&quot;)</span>
    <span class='c1'>#         input_waveform = self.input_conv(cur_waveform[:, :, -self.receptive_field:])</span>
    <span class='c1'>#         cur_result = torch.zeros_like(input_waveform, device=self.device)</span>
    <span class='c1'>#         prev = input_waveform</span>
    <span class='c1'>#         for block in self.residual_blocks:</span>
    <span class='c1'>#             block_result = block(prev, spectrogram[:, :, max(0, cur_waveform.shape[2] -self.receptive_field):cur_waveform.shape[2]])</span>
    <span class='c1'>#             cur_result += block_result</span>
    <span class='c1'>#             block_result += prev</span>
    <span class='c1'>#             prev = block_result</span>
    <span class='c1'>#         cur_result = self.output_conv(cur_result)</span>
    <span class='c1'>#         cur_result = cur_result[:, :, [-1]].argmax(dim=1, keepdim=True)</span>
    <span class='c1'>#         cur_waveform = torch.cat([cur_waveform, cur_result], dim=2)</span>
    <span class='c1'>#</span>
    <span class='c1'>#     return cur_waveform</span>

<div class='viewcode-block' id='UNet.step'><a class='viewcode-back' href='../../../../generated/modulation.classification.seperation.audio_unet.UNet.html#modulation.classification.seperation.audio_unet.UNet.step'>[docs]</a>    <span class='k'>def</span> <span class='nf'>step</span><span class='p'>(</span>
        <span class='bp'>self</span><span class='p'>,</span>
        <span class='n'>batch</span><span class='p'>:</span> <span class='n'>Tuple</span><span class='p'>[</span><span class='n'>torch</span><span class='o'>.</span><span class='n'>Tensor</span><span class='p'>,</span> <span class='n'>torch</span><span class='o'>.</span><span class='n'>Tensor</span><span class='p'>,</span> <span class='n'>List</span><span class='p'>[</span><span class='nb'>int</span><span class='p'>]],</span>
        <span class='n'>batch_idx</span><span class='p'>:</span> <span class='nb'>int</span><span class='p'>,</span>
        <span class='n'>inference</span><span class='p'>:</span> <span class='nb'>bool</span><span class='p'>,</span>
    <span class='p'>)</span> <span class='o'>-&gt;</span> <span class='n'>Tuple</span><span class='p'>[</span>
        <span class='n'>torch</span><span class='o'>.</span><span class='n'>Tensor</span><span class='p'>,</span>
        <span class='n'>torch</span><span class='o'>.</span><span class='n'>Tensor</span><span class='p'>,</span>
        <span class='n'>torch</span><span class='o'>.</span><span class='n'>Tensor</span><span class='p'>,</span>
        <span class='n'>torch</span><span class='o'>.</span><span class='n'>Tensor</span><span class='p'>,</span>
        <span class='n'>torch</span><span class='o'>.</span><span class='n'>Tensor</span><span class='p'>,</span>
        <span class='n'>torch</span><span class='o'>.</span><span class='n'>Tensor</span><span class='p'>,</span>
        <span class='n'>List</span><span class='p'>[</span><span class='nb'>int</span><span class='p'>],</span>
    <span class='p'>]:</span>
        <span class='sd'>&quot;&quot;&quot;</span>
<span class='sd'>        Pass batch to network, calculate losses and return total loss with gt and predicted spectrograms</span>
<span class='sd'>        &quot;&quot;&quot;</span>
        <span class='n'>mixture</span><span class='p'>,</span> <span class='n'>no_vocals</span><span class='p'>,</span> <span class='n'>sr</span> <span class='o'>=</span> <span class='n'>batch</span>
        <span class='n'>mixture_mag</span><span class='p'>,</span> <span class='n'>mixture_phase</span> <span class='o'>=</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>spec_transform</span><span class='p'>(</span><span class='n'>mixture</span><span class='p'>)</span>
        <span class='n'>no_vocals_mag</span><span class='p'>,</span> <span class='n'>no_vocals_phase</span> <span class='o'>=</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>spec_transform</span><span class='p'>(</span><span class='n'>no_vocals</span><span class='p'>)</span>
        <span class='n'>pred_mag</span> <span class='o'>=</span> <span class='p'>(</span>
            <span class='bp'>self</span><span class='p'>(</span><span class='n'>torch</span><span class='o'>.</span><span class='n'>log</span><span class='p'>(</span><span class='n'>mixture_mag</span><span class='o'>.</span><span class='n'>masked_fill</span><span class='p'>((</span><span class='n'>mixture_mag</span> <span class='o'>&lt;=</span> <span class='mi'>0</span><span class='p'>),</span> <span class='mf'>1e-5</span><span class='p'>)))</span>
            <span class='o'>*</span> <span class='n'>mixture_mag</span>
        <span class='p'>)</span>

        <span class='n'>loss</span> <span class='o'>=</span> <span class='n'>nn</span><span class='o'>.</span><span class='n'>L1Loss</span><span class='p'>()(</span><span class='n'>pred_mag</span><span class='p'>,</span> <span class='n'>no_vocals_mag</span><span class='p'>)</span>

        <span class='k'>return</span> <span class='p'>(</span>
            <span class='n'>loss</span><span class='p'>,</span>
            <span class='n'>pred_mag</span><span class='p'>,</span>
            <span class='n'>mixture_mag</span><span class='p'>,</span>
            <span class='n'>mixture_phase</span><span class='p'>,</span>
            <span class='n'>no_vocals_mag</span><span class='p'>,</span>
            <span class='n'>no_vocals_phase</span><span class='p'>,</span>
            <span class='n'>sr</span><span class='p'>,</span>
        <span class='p'>)</span></div>

<div class='viewcode-block' id='UNet.training_step'><a class='viewcode-back' href='../../../../generated/modulation.classification.seperation.audio_unet.UNet.html#modulation.classification.seperation.audio_unet.UNet.training_step'>[docs]</a>    <span class='k'>def</span> <span class='nf'>training_step</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span> <span class='n'>batch</span><span class='p'>,</span> <span class='n'>batch_idx</span><span class='p'>):</span>
        <span class='sd'>&quot;&quot;&quot;</span>

<span class='sd'>        :param batch:</span>
<span class='sd'>        :type batch:</span>
<span class='sd'>        :param batch_idx:</span>
<span class='sd'>        :type batch_idx:</span>
<span class='sd'>        :return:</span>
<span class='sd'>        :rtype:</span>
<span class='sd'>        &quot;&quot;&quot;</span>
        <span class='p'>(</span>
            <span class='n'>loss</span><span class='p'>,</span>
            <span class='o'>*</span><span class='n'>_</span><span class='p'>,</span>
        <span class='p'>)</span> <span class='o'>=</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>step</span><span class='p'>(</span><span class='n'>batch</span><span class='p'>,</span> <span class='n'>batch_idx</span><span class='p'>,</span> <span class='n'>inference</span><span class='o'>=</span><span class='kc'>False</span><span class='p'>)</span>

        <span class='bp'>self</span><span class='o'>.</span><span class='n'>log</span><span class='p'>(</span><span class='s2'>&quot;train_loss&quot;</span><span class='p'>,</span> <span class='n'>loss</span><span class='p'>)</span>
        <span class='k'>return</span> <span class='n'>loss</span></div>

<div class='viewcode-block' id='UNet.validation_step'><a class='viewcode-back' href='../../../../generated/modulation.classification.seperation.audio_unet.UNet.html#modulation.classification.seperation.audio_unet.UNet.validation_step'>[docs]</a>    <span class='k'>def</span> <span class='nf'>validation_step</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>,</span> <span class='n'>batch</span><span class='p'>,</span> <span class='n'>batch_idx</span><span class='p'>,</span> <span class='n'>metric_writer</span><span class='p'>:</span> <span class='n'>Writer</span><span class='p'>):</span>
        <span class='sd'>&quot;&quot;&quot;</span>

<span class='sd'>        :param batch:</span>
<span class='sd'>        :type batch:</span>
<span class='sd'>        :param batch_idx:</span>
<span class='sd'>        :type batch_idx:</span>
<span class='sd'>        :return:</span>
<span class='sd'>        :rtype:</span>
<span class='sd'>        &quot;&quot;&quot;</span>
        <span class='c1'># Calculate losses and results in training and inference modes</span>
        <span class='p'>(</span>
            <span class='n'>loss</span><span class='p'>,</span>
            <span class='n'>pred_mag</span><span class='p'>,</span>
            <span class='n'>mixture_mag</span><span class='p'>,</span>
            <span class='n'>mixture_phase</span><span class='p'>,</span>
            <span class='n'>no_vocals_mag</span><span class='p'>,</span>
            <span class='n'>no_vocals_phase</span><span class='p'>,</span>
            <span class='n'>sr</span><span class='p'>,</span>
        <span class='p'>)</span> <span class='o'>=</span> <span class='bp'>self</span><span class='o'>.</span><span class='n'>step</span><span class='p'>(</span><span class='n'>batch</span><span class='p'>,</span> <span class='n'>batch_idx</span><span class='p'>,</span> <span class='n'>inference</span><span class='o'>=</span><span class='kc'>False</span><span class='p'>)</span>
        <span class='c1'># pred_waveform = self.inv_spec_transform((pred_mag, mixture_phase))</span>
        <span class='c1'># mixed_waveform = self.inv_spec_transform((mixture_mag, mixture_phase))</span>
        <span class='c1'># instrument_waveform = self.inv_spec_transform((no_vocals_mag, no_vocals_phase))</span>

        <span class='n'>mixed_audio</span> <span class='o'>=</span> <span class='p'>[</span>
            <span class='c1'># wandb.Audio(wav.detach().cpu(), sample_rate=sr[0]) for wav in mixed_waveform</span>
        <span class='p'>]</span>
        <span class='n'>pred_audio</span> <span class='o'>=</span> <span class='p'>[</span>
            <span class='c1'># wandb.Audio(wav.detach().cpu(), sample_rate=sr[0]) for wav in pred_waveform</span>
        <span class='p'>]</span>
        <span class='n'>instrument_audio</span> <span class='o'>=</span> <span class='p'>[</span>
            <span class='c1'># wandb.Audio(wav.detach().cpu(), sample_rate=sr[0]) for wav in instrument_waveform</span>
        <span class='p'>]</span>

        <span class='n'>metric_writer</span><span class='o'>.</span><span class='n'>scalar</span><span class='p'>(</span><span class='s2'>&quot;Mixed audio&quot;</span><span class='p'>,</span> <span class='n'>mixed_audio</span><span class='p'>)</span>
        <span class='n'>metric_writer</span><span class='o'>.</span><span class='n'>scalar</span><span class='p'>(</span><span class='s2'>&quot;Predicted audio&quot;</span><span class='p'>,</span> <span class='n'>pred_audio</span><span class='p'>)</span>
        <span class='n'>metric_writer</span><span class='o'>.</span><span class='n'>scalar</span><span class='p'>(</span><span class='s2'>&quot;True audio&quot;</span><span class='p'>,</span> <span class='n'>instrument_audio</span><span class='p'>)</span>
        <span class='n'>metric_writer</span><span class='o'>.</span><span class='n'>scalar</span><span class='p'>(</span><span class='s2'>&quot;val_loss&quot;</span><span class='p'>,</span> <span class='n'>loss</span><span class='p'>)</span>

        <span class='k'>return</span> <span class='p'>(</span>
            <span class='n'>loss</span><span class='p'>,</span>
            <span class='n'>pred_mag</span><span class='p'>,</span>
            <span class='n'>mixture_mag</span><span class='p'>,</span>
            <span class='n'>mixture_phase</span><span class='p'>,</span>
            <span class='n'>no_vocals_mag</span><span class='p'>,</span>
            <span class='n'>no_vocals_phase</span><span class='p'>,</span>
        <span class='p'>)</span></div>

    <span class='c1'># def validation_epoch_end(self, outputs):</span>
    <span class='c1'>#     val_loss, true_waveform, val_pred_waveform, spectrogram = outputs[-1]</span>
    <span class='c1'>#     inf_waveform = self.inference(spectrogram[:4])</span>
    <span class='c1'>#     inf_waveform = torchaudio.functional.mu_law_decoding(inf_waveform, self.n_mu_law).squeeze(1)</span>
    <span class='c1'>#</span>
    <span class='c1'>#     inf_audio = [wandb.Audio(wav.detach().cpu(), sample_rate=22050) for wav in inf_waveform]</span>
    <span class='c1'>#     self.logger.experiment.log({&quot;Inferenced audio&quot;: inf_audio}, commit=False)</span>

<div class='viewcode-block' id='UNet.configure_optimizers'><a class='viewcode-back' href='../../../../generated/modulation.classification.seperation.audio_unet.UNet.html#modulation.classification.seperation.audio_unet.UNet.configure_optimizers'>[docs]</a>    <span class='k'>def</span> <span class='nf'>configure_optimizers</span><span class='p'>(</span><span class='bp'>self</span><span class='p'>)</span> <span class='o'>-&gt;</span> <span class='nb'>dict</span><span class='p'>:</span>
        <span class='sd'>&quot;&quot;&quot;</span>

<span class='sd'>        :return:</span>
<span class='sd'>        :rtype:</span>
<span class='sd'>        &quot;&quot;&quot;</span>
        <span class='n'>optimizer</span> <span class='o'>=</span> <span class='n'>torch</span><span class='o'>.</span><span class='n'>optim</span><span class='o'>.</span><span class='n'>Adam</span><span class='p'>(</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>parameters</span><span class='p'>(),</span> <span class='n'>lr</span><span class='o'>=</span><span class='bp'>self</span><span class='o'>.</span><span class='n'>optimizer_lr</span><span class='p'>)</span>
        <span class='k'>return</span> <span class='p'>{</span>
            <span class='s2'>&quot;optimizer&quot;</span><span class='p'>:</span> <span class='n'>optimizer</span><span class='p'>,</span>
        <span class='p'>}</span></div></div>


<span class='k'>if</span> <span class='vm'>__name__</span> <span class='o'>==</span> <span class='s2'>&quot;__main__&quot;</span><span class='p'>:</span>
    <span class='k'>pass</span>
    <span class='n'>unet</span> <span class='o'>=</span> <span class='n'>UNet</span><span class='p'>()</span>
    <span class='n'>unet</span><span class='o'>.</span><span class='n'>train</span><span class='p'>()</span>
</pre>
            </div>

          </div>

        </div>
      </div>
      <div aria-label='main navigation' class='sphinxsidebar' role='navigation'>
        <div class='sphinxsidebarwrapper'>
          <p class='logo'><a href='../../../../index.html'>
            <img alt='Logo' class='logo' src='../../../../_static/mod.svg'/>
          </a></p>
          <h1 class='logo'><a href='../../../../index.html'>modulation</a></h1>


          <h3>Navigation</h3>
          <ul>
            <li class='toctree-l1'><a class='reference internal' href='../../../../generated/modulation.html'>modulation</a></li>
          </ul>
          <p class='caption' role='heading'><span class='caption-text'>Notes</span></p>
          <ul>
            <li class='toctree-l1'><a class='reference internal' href='../../../../getting_started.html'>Getting Started</a></li>
          </ul>

          <div class='relations'>
            <h3>Related Topics</h3>
            <ul>
              <li><a href='../../../../index.html'>Documentation overview</a>
                <ul>
                  <li><a href='../../../index.html'>Module code</a>
                    <ul>
                      <li><a href='../../../modulation.html'>modulation</a>
                        <ul>
                        </ul>
                      </li>
                    </ul>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
          <div id='searchbox' role='search' style='display: none'>
            <h3 id='searchlabel'>Quick search</h3>
            <div class='searchformwrapper'>
              <form action='../../../../search.html' class='search' method='get'>
                <input aria-labelledby='searchlabel' autocapitalize='off' autocomplete='off' autocorrect='off' name='q' spellcheck='false' type='text'/>
                <input type='submit' value='Go'/>
              </form>
            </div>
          </div>
          <script>document.getElementById('searchbox').style.display = "block"</script>


        </div>
      </div>
      <div class='clearer'></div>
    </div>
    <div class='footer'>
      &copy;.

      |
      Powered by <a href='http://sphinx-doc.org/'>Sphinx 5.0.2</a>
      &amp; <a href='https://github.com/bitprophet/alabaster'>Alabaster 0.7.12</a>

    </div>


  </body>
</html>